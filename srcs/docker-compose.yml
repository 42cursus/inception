version: "3.8"

#Les variables d'environnement doivent toutes etre dans un fichier .env
#Le tag latest est interdit
#3 grandes sections - les services (=les containers), les networks (=la communication), 
#les volumes (les fichiers/ressources)

#Pour rappel nous travaillons LEMP Stack

#Attention l'indentation est tres important dans un fichier yaml

#Definir les networks et volumes avant les services ne devrait pas avoir de difference. 

#https://docs.docker.com/compose/networking/
#Si la directive networks n'est pas specifiee, un network sera cree par defaut
#Sinon, nous avons la possibilite de definir plusieurs networks et de
#determiner quels sont les services qui y ont acces
networks:
    inception_network:
        name: inception

#https://docs.docker.com/storage/volumes/
#https://www.it-swarm-fr.com/fr/docker/docker-compose.yml-syntaxe-des-volumes-nommes/806987524/
#Volumes are the preferred mechanism for persisting data generated by and used by Docker containers. 
#Volumes are "completely managed by Docker"       
volumes:
        wordpress_data:
                name: wordpress_data
                driver: local
                driver_opts:
                    type: none
                    device: /home/malatini/data/wordpress
                    o: bind
                
        db_data:
                name: db_data
                driver: local
                driver_opts:
                    type: none
                    device: /home/malatini/data/mysql
                    o: bind


#Nos containers/services
#Pour les services, l'ordre a un sens, mais on peut aussi ajouter la directive
#depends_on pour verifier qu'un service soit bien up avant un autre 
#pour eviter des erreurs de connectivite ou autres
#meme si les variables d'environnement sont dans le .env il faut quand meme 
#proceder a l'"interpolation" de celles ci".
services:
        mariadb:  
            container_name: mariadb_inception
            build: ./mariadb
            volumes:
                    - mariadb:/var/lib/mysql
            networks:
                    - localhost
            image: mariadb
            restart: always
        wordpress:
            depends_on:
                - mariadb
            container_name: wordpress_inception
            build: ./wordpress
            image: wordpress
            volumes:
                - wordpress:/var/www/wordpress
            networks:
                - localhost
            restart: always
        nginx:
            depends_on:
                - wordpress
            container_name: nginx_inception
            build: ./nginx
            image: nginx
            #Only accessible port as requested
            ports:
                - "443:443"
            volumes:
                - wordpress:/var/www/wordpress
            networks:
                - localhost
            restart: always
